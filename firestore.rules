rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function authed() { return request.auth != null; }

    function isNonEmptyString(field, maxLen) {
      return field is string && field.size() >= 1 && field.size() <= maxLen;
    }

    function isString(field, maxLen) {
      return field is string && field.size() <= maxLen;
    }

    function isOptionalString(field, maxLen) {
      return field == null || isString(field, maxLen);
    }

    function isStringList(list, maxItems, minLen, maxLen) {
      return list is list
        && list.size() <= maxItems
        && list.size() == list.where(item,
          item is string && item.size() >= minLen && item.size() <= maxLen
        ).size();
    }

    function isOptionalStringList(field, maxItems, minLen, maxLen) {
      return field == null || isStringList(field, maxItems, minLen, maxLen);
    }

    function isTimestamp(value) {
      return value is timestamp || value == request.time;
    }

    function hasNoteContent(data) {
      return (
          ("content" in data && isString(data.content, 60000) && data.content.size() > 0)
        || ("contentMarkdown" in data && isString(data.contentMarkdown, 60000) && data.contentMarkdown.size() > 0)
      );
    }

    function isValidNoteData(data) {
      return data.uid is string
        && isNonEmptyString(data.title, 100)
        && (!("content" in data) || isString(data.content, 60000))
        && (!("contentMarkdown" in data) || isString(data.contentMarkdown, 60000))
        && hasNoteContent(data)
        && ("description" in data ? isOptionalString(data.description, 300) : true)
        && ("isFavorite" in data ? data.isFavorite is bool : true)
        && ("category" in data ? (data.category == null || isString(data.category, 100)) : true)
        && (!("tags" in data) || isStringList(data.tags, 500, 1, 100))
        && (!("linkedCabinetIds" in data) || isStringList(data.linkedCabinetIds, 50, 1, 100))
        && (!("linkedItemIds" in data) || isStringList(data.linkedItemIds, 50, 1, 100))
        && (!("createdAt" in data) || isTimestamp(data.createdAt))
        && (!("updatedAt" in data) || isTimestamp(data.updatedAt));
    }

    // 櫃子
    match /cabinet/{id} {
      allow read: if authed() && resource.data.uid == request.auth.uid;
      allow create: if authed() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if authed() && resource.data.uid == request.auth.uid;
    }

    // 物件
    match /item/{id} {
      allow read: if authed() && resource.data.uid == request.auth.uid;
      allow create: if authed() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if authed() && resource.data.uid == request.auth.uid;

      // 進度（不需要在子文件存 uid，改查父 item 的 uid）
      match /progress/{pid} {
        allow read, create, update, delete:
          if authed() &&
             get(/databases/$(database)/documents/item/$(id)).data.uid == request.auth.uid;
      }
    }

    // 垃圾桶
    match /cabinetTrash/{itemId} {
      allow read: if authed() && resource.data.uid == request.auth.uid;
      allow create: if authed() && request.resource.data.uid == request.auth.uid;
      allow update: if authed() &&
                     resource.data.uid == request.auth.uid &&
                     request.resource.data.uid == request.auth.uid;
      allow delete: if authed() && resource.data.uid == request.auth.uid;
    }

    // 標籤
    match /tag/{id} {
      allow read: if authed() && resource.data.uid == request.auth.uid;
      allow create: if authed() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if authed() && resource.data.uid == request.auth.uid;
    }

    // 筆記本
    match /note/{id} {
      allow read: if authed() && resource.data.uid == request.auth.uid;
      allow create: if authed()
                    && request.resource.data.uid == request.auth.uid
                    && isValidNoteData(request.resource.data)
                    && ("createdAt" in request.resource.data)
                    && ("updatedAt" in request.resource.data);
      allow update: if authed()
                    && resource.data.uid == request.auth.uid
                    && request.resource.data.uid == request.auth.uid
                    && isValidNoteData(request.resource.data)
                    && ("createdAt" in resource.data ? ("createdAt" in request.resource.data && request.resource.data.createdAt == resource.data.createdAt) : true);
      allow delete: if authed() && resource.data.uid == request.auth.uid;
    }

    // 使用者偏好
    match /user/{uid} {
      allow read, write: if authed() && request.auth.uid == uid;
    }
  }
}
